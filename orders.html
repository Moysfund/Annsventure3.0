<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ann’s Ventures — Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--pink:#ff5f9a; --rose:#7a2a56; --border:#f4c2d8;}
    body{margin:0;font-family:'Poppins',sans-serif;color:#2a2a2a}
    header{background:var(--pink);color:#fff;text-align:center;padding:12px;font-weight:600}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    h1{font-family:'Playfair Display',serif;color:var(--rose);margin:10px 0 16px}

    .filters{margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap}
    .filters button{padding:6px 12px;border:none;border-radius:8px;background:var(--pink);color:#fff;font-weight:600;cursor:pointer}
    .filters button.active{background:#cf3f7c}

    .order{border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px;background:#fff}
    .order h3{margin:0 0 8px;color:var(--rose);display:flex;align-items:center;gap:10px}
    .badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;color:#fff}
    .badge.pending{background:#f0ad4e}
    .badge.shipped{background:#5bc0de}
    .badge.completed{background:#5cb85c}

    .row{display:flex;gap:12px;flex-wrap:wrap;font-size:14px;color:#444}
    .items{margin-top:8px;font-size:14px}
    .item{padding:4px 0;border-bottom:1px dashed #f3d0de}
    .item:last-child{border-bottom:none}
    .total{font-weight:700;color:var(--pink);margin-top:8px}

    .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .status{padding:6px 12px;border:1px solid var(--border);border-radius:8px;font-family:inherit}
    .delete{padding:6px 12px;border:none;border-radius:8px;background:#a33;color:#fff;font-weight:600;cursor:pointer}

    .empty{color:#7a2a56;text-align:center;padding:20px}

    footer{margin-top:30px;padding:20px;text-align:center;color:#666;font-size:13px;border-top:1px solid var(--border)}
    footer a{color:var(--rose);text-decoration:none;font-weight:600}
    #logoutBtn{background:#ff5f9a;color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  </style>
</head>
<body>
  <header>Ann’s Ventures — Orders</header>

  <div class="wrap">
    <h1>Incoming orders</h1>

    <!-- Filter bar -->
    <div class="filters">
      <button data-filter="All" class="active">All</button>
      <button data-filter="Pending">Pending</button>
      <button data-filter="Shipped">Shipped</button>
      <button data-filter="Completed">Completed</button>
    </div>

    <div id="orders"></div>
    <div id="no-orders" class="empty" style="display:none">No orders yet.</div>
  </div>

  <footer>
    <a href="index.html">Storefront</a> • 
    <a href="admin.html">Product admin</a> • 
    <button id="logoutBtn">Logout</button>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeuEMpCf90Y8P5M0Xahwi_zMeHZeqod-Q",
    authDomain: "annsventure-51957.firebaseapp.com",
    projectId: "annsventure-51957",
    storageBucket: "annsventure-51957.appspot.com",
    messagingSenderId: "1054919145056",
    appId: "1:1054919145056:web:64c35fc1507000984b3505",
    measurementId: "G-SSN8TYCRWQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Protect page
  onAuthStateChanged(auth, user=>{
    if(!user){
      window.location.href="login.html";
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    signOut(auth).then(()=> window.location.href="login.html");
  });

  const ordersEl = document.getElementById('orders');
  const emptyEl = document.getElementById('no-orders');
  const filterButtons = document.querySelectorAll('.filters button');

  let activeFilter = "All";
  let allOrders = []; // array of QueryDocumentSnapshot

  // Render a list of orders (array of QueryDocumentSnapshot)
  function renderOrders(list){
    ordersEl.innerHTML='';
    if(list.length===0){
      emptyEl.style.display='block';
      return;
    }
    emptyEl.style.display='none';

    list.forEach(docSnap=>{
      const o = docSnap.data();
      const id = docSnap.id;

      const status = o.status || "Pending";
      const badgeClass = status.toLowerCase();

      const itemsList = (o.items||[]).map(i=>`<div class="item">${i.title} — ₦${i.price}</div>`).join('');
      const created = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() : '';

      const card = document.createElement('div');
      card.className = 'order';
      card.innerHTML = `
        <h3>Order <span class="badge ${badgeClass}">${status}</span></h3>
        <div class="row">
          <div><strong>Name:</strong> ${o.customer?.name||''}</div>
          <div><strong>Email:</strong> ${o.customer?.email||''}</div>
          <div><strong>Phone:</strong> ${o.customer?.phone||''}</div>
        </div>
        <div class="row">
          <div><strong>Address:</strong> ${o.customer?.address||''}</div>
          <div><strong>Date:</strong> ${created}</div>
        </div>
        <div class="items">${itemsList}</div>
        <div class="total">Total: ₦${o.total||0}</div>
        <div class="actions">
          <select class="status">
            <option value="Pending" ${status==="Pending"?"selected":""}>Pending</option>
            <option value="Shipped" ${status==="Shipped"?"selected":""}>Shipped</option>
            <option value="Completed" ${status==="Completed"?"selected":""}>Completed</option>
          </select>
          <button class="delete">Delete</button>
        </div>
      `;

      // Status change
      card.querySelector('.status').addEventListener('change', async (e)=>{
        await updateDoc(doc(db,"orders",id), { status: e.target.value });
      });

      // Delete
      card.querySelector('.delete').addEventListener('click', async ()=>{
        if(confirm("Delete this order?")){
          await deleteDoc(doc(db,"orders",id));
        }
      });

      ordersEl.appendChild(card);
    });
  }

  // Apply filter to allOrders and render
  function applyFilter(){
    if(activeFilter === "All"){
      renderOrders(allOrders);
      return;
    }
    const filtered = allOrders.filter(snap => (snap.data().status || "Pending") === activeFilter);
    renderOrders(filtered);
  }

  // Live snapshot
  const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot)=>{
    allOrders = [];
    snapshot.forEach(docSnap=> allOrders.push(docSnap));
    applyFilter();
  });

  // Filter buttons UI
  filterButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      filterButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      activeFilter = btn.dataset.filter;
      applyFilter();
    });
  });
</script>
</body>
</html>
